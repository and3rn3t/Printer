# ──────────────────────────────────────────────────────────────
# Printer — iOS CI  (optimized)
# Lints, builds, tests, and builds the widget — all in parallel.
#
# Key optimizations vs. previous version:
#   • Shared composite action for Xcode / simulator / tool setup
#   • Homebrew, SPM, and DerivedData caching
#   • Merged build + test into one job (build-for-testing ➜ test-without-building)
#   • All three jobs run in parallel (no serial build→test chain)
# ──────────────────────────────────────────────────────────────

name: iOS CI

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - '.github/copilot-instructions.md'
      - 'LICENSE'
  pull_request:
    branches: [main]
    paths-ignore:
      - '**.md'
      - '.github/copilot-instructions.md'
      - 'LICENSE'
  workflow_dispatch: # allow manual trigger

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  SCHEME: Printer
  PROJECT: Printer.xcodeproj
  XCBEAUTIFY_OPTS: "--disable-colored-output"
  DERIVED_DATA: build/DerivedData

jobs:
  # ── 1. SwiftLint (parallel) ───────────────────────────────
  lint:
    name: SwiftLint
    runs-on: macos-15
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode environment
        uses: ./.github/actions/setup-xcode
        with:
          install-xcbeautify: "false"
          install-swiftlint: "true"

      - name: Lint
        run: swiftlint lint --strict --config .swiftlint.yml --reporter github-actions-logging

  # ── 2. Build + Test (parallel) ────────────────────────────
  build-and-test:
    name: Build & Test (iOS)
    runs-on: macos-15
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode environment
        id: setup
        uses: ./.github/actions/setup-xcode

      # ── SPM package cache ──────────────────────────────────
      - name: Cache SPM packages
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
            ${{ env.DERIVED_DATA }}/SourcePackages
          key: spm-${{ runner.os }}-${{ hashFiles('**/Package.resolved', '**/project.pbxproj') }}
          restore-keys: |
            spm-${{ runner.os }}-

      # ── DerivedData cache ──────────────────────────────────
      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: ${{ env.DERIVED_DATA }}
          key: deriveddata-${{ runner.os }}-${{ hashFiles('**/*.swift', '**/project.pbxproj') }}
          restore-keys: |
            deriveddata-${{ runner.os }}-

      - name: Resolve package dependencies
        run: |
          xcodebuild -project "$PROJECT" \
            -scheme "$SCHEME" \
            -derivedDataPath "$DERIVED_DATA" \
            -resolvePackageDependencies \
            2>&1 | xcbeautify $XCBEAUTIFY_OPTS

      # build-for-testing compiles everything once; test-without-building
      # re-uses those products — no redundant rebuild.
      - name: Build for testing
        run: |
          set -o pipefail
          xcodebuild build-for-testing \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -destination "${{ steps.setup.outputs.destination }}" \
            -derivedDataPath "$DERIVED_DATA" \
            -configuration Debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            COMPILER_INDEX_STORE_ENABLE=NO \
            2>&1 | xcbeautify $XCBEAUTIFY_OPTS

      - name: Run tests (without rebuilding)
        run: |
          set -o pipefail
          xcodebuild test-without-building \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -destination "${{ steps.setup.outputs.destination }}" \
            -derivedDataPath "$DERIVED_DATA" \
            -resultBundlePath TestResults.xcresult \
            -enableCodeCoverage YES \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            2>&1 | xcbeautify $XCBEAUTIFY_OPTS

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: TestResults
          path: TestResults.xcresult
          retention-days: 14
          if-no-files-found: warn

  # ── 3. Build Widget Extension (parallel) ──────────────────
  build-widget:
    name: Build Widget Extension
    runs-on: macos-15
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode environment
        id: setup
        uses: ./.github/actions/setup-xcode

      # ── DerivedData cache (widget) ─────────────────────────
      - name: Cache DerivedData (widget)
        uses: actions/cache@v4
        with:
          path: ${{ env.DERIVED_DATA }}
          key: deriveddata-widget-${{ runner.os }}-${{ hashFiles('**/*.swift', '**/project.pbxproj') }}
          restore-keys: |
            deriveddata-widget-${{ runner.os }}-

      - name: Build widget extension
        run: |
          set -o pipefail
          xcodebuild build \
            -project "$PROJECT" \
            -scheme widgetExtension \
            -destination "${{ steps.setup.outputs.destination }}" \
            -derivedDataPath "$DERIVED_DATA" \
            -configuration Debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            COMPILER_INDEX_STORE_ENABLE=NO \
            2>&1 | xcbeautify $XCBEAUTIFY_OPTS
