# ──────────────────────────────────────────────────────────────
# Printer — iOS CI
# Lints, builds, tests, and builds the widget — all in parallel.
#
# Key optimizations:
#   • Shared composite action for Xcode / simulator / tool setup
#   • Homebrew caching for tools
#   • build-for-testing ➜ test-without-building (single compile)
#   • No SPM/DerivedData caching (no packages; DD cache misses
#     on every Swift change cost more than a clean rebuild)
#   • Parallel compilation via JOBS flag
#   • Widget built alongside main scheme in one job
# ──────────────────────────────────────────────────────────────

name: iOS CI

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - '.github/copilot-instructions.md'
      - 'LICENSE'
  pull_request:
    branches: [main]
    paths-ignore:
      - '**.md'
      - '.github/copilot-instructions.md'
      - 'LICENSE'
  workflow_dispatch: # allow manual trigger

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  SCHEME: Printer
  PROJECT: Printer.xcodeproj
  XCBEAUTIFY_OPTS: "--disable-colored-output"

jobs:
  # ── 1. SwiftLint (parallel) ───────────────────────────────
  lint:
    name: SwiftLint
    runs-on: macos-15
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode environment
        uses: ./.github/actions/setup-xcode
        with:
          install-xcbeautify: "false"
          install-swiftlint: "true"

      - name: Lint
        run: swiftlint lint --strict --config .swiftlint.yml --reporter github-actions-logging

  # ── 2. Build + Test (parallel) ────────────────────────────
  build-and-test:
    name: Build & Test (iOS)
    runs-on: macos-15
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode environment
        id: setup
        uses: ./.github/actions/setup-xcode

      # build-for-testing compiles everything once; test-without-building
      # re-uses those products — no redundant rebuild.
      - name: Build for testing
        run: |
          set -o pipefail
          xcodebuild build-for-testing \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -destination "${{ steps.setup.outputs.destination }}" \
            -configuration Debug \
            -only-testing:PrinterTests \
            -jobs $(sysctl -n hw.ncpu) \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            COMPILER_INDEX_STORE_ENABLE=NO \
            GCC_OPTIMIZATION_LEVEL=s \
            SWIFT_OPTIMIZATION_LEVEL=-Onone \
            DEBUG_INFORMATION_FORMAT=dwarf \
            ENABLE_TESTABILITY=YES \
            2>&1 | xcbeautify $XCBEAUTIFY_OPTS

      - name: Run tests (without rebuilding)
        run: |
          set -o pipefail
          xcodebuild test-without-building \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -destination "${{ steps.setup.outputs.destination }}" \
            -only-testing:PrinterTests \
            -resultBundlePath TestResults.xcresult \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            2>&1 | xcbeautify $XCBEAUTIFY_OPTS

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: TestResults
          path: TestResults.xcresult
          retention-days: 14
          if-no-files-found: warn

  # ── 3. Build Widget Extension (parallel) ──────────────────
  build-widget:
    name: Build Widget Extension
    runs-on: macos-15
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode environment
        id: setup
        uses: ./.github/actions/setup-xcode

      - name: Build widget extension
        run: |
          set -o pipefail
          xcodebuild build \
            -project "$PROJECT" \
            -scheme widgetExtension \
            -destination "${{ steps.setup.outputs.destination }}" \
            -configuration Debug \
            -jobs $(sysctl -n hw.ncpu) \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            COMPILER_INDEX_STORE_ENABLE=NO \
            GCC_OPTIMIZATION_LEVEL=s \
            SWIFT_OPTIMIZATION_LEVEL=-Onone \
            DEBUG_INFORMATION_FORMAT=dwarf \
            2>&1 | xcbeautify $XCBEAUTIFY_OPTS
